<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DXLR – Portal</title>
  <style>
    body{margin:0;font-family:Inter,system-ui,Arial;background:#09282e;color:#fff}
    .wrap{max-width:940px;margin:24px auto;padding:0 16px}
    h1{color:#86e10e}
    .card{border:1px solid #86e10e;border-radius:16px;padding:16px;margin:12px 0;background:#0f3a41}
    input,select,button{padding:12px;border-radius:10px;border:1px solid #86e10e;background:#09282e;color:#fff}
    button{background:#86e10e;color:#09282e;border:none;font-weight:900}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .mt{margin-top:12px}
    label{display:block;margin:6px 0 4px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>بوابة DXLR للمرتجعات والاستبدالات</h1>
    <div class="card">
      <label>رقم الطلب</label>
      <input id="orderNumber" placeholder="مثال: 1234" />
      <label class="mt">رقم الموبايل</label>
      <input id="phone" placeholder="+2010..." />
      <div class="mt"><button id="lookup">عرض الطلب</button></div>
      <div id="lookupResult" class="mt"></div>
    </div>

    <div id="flow" class="card" style="display:none">
      <label>نوع الطلب</label>
      <select id="type"><option value="return">استرجاع</option><option value="exchange">استبدال</option></select>
      <div id="items" class="mt"></div>
      <label class="mt">سبب الطلب</label>
      <input id="reason" placeholder="اكتب السبب بإيجاز" />
      <div class="mt"><label><input type="checkbox" id="agree" /> أوافق على تحمل تكلفة الشحن والمدة ٥ أيام عمل</label></div>
      <div class="mt"><button id="submit">إرسال الطلب</button></div>
      <div id="submitResult" class="mt"></div>
    </div>
  </div>
  <script>
    const API = {
      lookup: '/api/portal/lookup',
      request: '/api/portal/request'
    };
    let currentOrder = null;
    let selected = {}; // lineItemId -> qty

    document.getElementById('lookup').onclick = async () => {
      const orderNumber = document.getElementById('orderNumber').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const res = await fetch(API.lookup,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orderNumber,phone})});
      const data = await res.json();
      const out = document.getElementById('lookupResult');
      if(!data.ok){ out.textContent = 'حصل خطأ: '+ data.error; return; }
      currentOrder = data.order;
      out.textContent = 'تم العثور على الطلب: ' + currentOrder.name;
      const itemsDiv = document.getElementById('items');
      itemsDiv.innerHTML = '<div>اختر الكميات المراد ارجاعها/استبدالها:</div>';
      selected = {};
      currentOrder.items.forEach(it => {
        selected[it.lineItemId] = 0;
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = '<div style="min-width:280px">'+it.title+(it.variantTitle?(' – '+it.variantTitle):'')+'</div>'+
                        '<div>اجمالي: '+it.quantityOrdered+'</div>'+
                        '<div><input id="qty_'+it.lineItemId+'" type="number" min="0" max="'+it.quantityOrdered+'" value="0" style="width:80px"/></div>';
        itemsDiv.appendChild(row);
        document.getElementById('qty_'+it.lineItemId).oninput = (e)=>{
          let v = parseInt(e.target.value||'0',10);
          if(v<0) v=0; if(v>it.quantityOrdered) v=it.quantityOrdered;
          selected[it.lineItemId]=v;
          e.target.value = v;
        };
      });
      document.getElementById('flow').style.display = 'block';
    };

    document.getElementById('submit').onclick = async () => {
      if(!currentOrder){ alert('اعرض الطلب الأول'); return; }
      const items = Object.entries(selected).filter(([k,v])=>v>0).map(([lineItemId,quantitySelected])=>({lineItemId,quantitySelected:Number(quantitySelected)}));
      if(items.length===0){ alert('اختر كمية واحدة على الأقل'); return; }
      const reason = document.getElementById('reason').value.trim();
      const acceptCost = document.getElementById('agree').checked;
      const type = document.getElementById('type').value;
      const payload = { type, orderId: currentOrder.id, orderNumber: currentOrder.name.replace('#',''), phone: document.getElementById('phone').value.trim(), reason, acceptCost, items };
      const res = await fetch(API.request,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data = await res.json();
      document.getElementById('submitResult').textContent = data.ok ? 'تم إرسال الطلب بنجاح' : ('فشل الإرسال: '+data.error);
    };
  </script>
</body>
</html>
